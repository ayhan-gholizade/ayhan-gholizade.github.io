<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>WorldCraft</title>

<link href="https://fonts.cdnfonts.com/css/iranian-sans" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ========== GENERAL ========== */
body{
  font-family:'Iranian Sans',Tahoma;
  direction:rtl;
  background:#0f172a;
  color:white;
  margin:0;
}
.container{
  width:520px;
  margin:40px auto;
  padding:0 10px;
}
.box{
  background:#020617;
  padding:18px;
  border-radius:14px;
  margin-bottom:20px;
  border:1px solid #334155;
}
input,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:10px;
  border:1px solid #334155;
  background:#0f172a;
  color:white;
  font-family:inherit;
}
button{
  background:#1d9bf0;
  cursor:pointer;
}
.row{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.profile{
  width:42px;
  height:42px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #1d9bf0;
  cursor:pointer;
}
.tick{
  width:18px;
  height:18px;
  border-radius:50%;
  background:#1d9bf0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
}
.admin{
  background:#1e1b4b;
}
.status{
  background:#020617;
  padding:10px;
  border-radius:10px;
  margin-bottom:10px;
  font-size:14px;
  border:1px solid #334155;
}
.deleteBtn{
  background:#dc2626;
  margin-top:5px;
}

/* ========== LOADING ========== */
#loading{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  color:white;font-size:24px;
  display:flex;align-items:center;justify-content:center;
  z-index:9999;
  display:none;
}

/* ========== RESPONSIVE / MOBILE ========== */
@media (max-width:600px){
  .container{
    width:100%;
    margin:20px auto;
    padding:0 10px;
  }
  .row{
    flex-direction:row;
    justify-content:flex-start;
  }
  .profile{
    width:36px;
    height:36px;
  }
  input,button{
    font-size:14px;
    padding:8px;
  }
  .status{
    font-size:13px;
  }
  .tick{
    width:16px;
    height:16px;
    font-size:11px;
  }
}
</style>
</head>

<body>
<div class="container" id="app"></div>
<div id="loading">در حال بارگذاری...</div>

<script>
/* ========= SUPABASE ========= */
const supabaseClient = supabase.createClient(
  "https://wuktgoyjxpwobkpwwuox.supabase.co",
  "sb_publishable_e2sWZT-e5Dn0au2v7n4X2w_5v8a8m92"
)

/* ========= GLOBAL ========= */
let current = null
let users = {}
let tweets = []
let settings = {}

function showLoading(show){
  document.getElementById("loading").style.display = show ? "flex" : "none"
}

/* ========= LOAD ========= */
async function loadAll(){
  showLoading(true)
  try{
    let {data: u} = await supabaseClient.from("users").select("*")
    let {data: t} = await supabaseClient.from("tweets").select("*").order("id")
    let {data: s} = await supabaseClient.from("settings").select("*").eq("id",1).single()
    users = {}; u.forEach(x=> users[x.username]=x)
    tweets = t || []
    settings = s || settings
    render()
  }finally{
    showLoading(false)
  }
}

/* ========= UI ========= */
function render(){
  let html=""
  if(!current){
    html+=`
    <div class="box">
      <h3>ورود</h3>
      <input id="u" placeholder="نام کاربری">
      <input id="p" type="password" placeholder="رمز">
      <button onclick="login()">ورود</button>
    </div>`
  }else{
    let me=users[current]
    html+=`
    <div class="box">
      <div class="row">
        <img class="profile" src="${me.pic||'https://via.placeholder.com/42'}" onclick="changePic()">
        <b onclick="changeName()" style="cursor:pointer">${me.name}</b>
        ${me.verified?'<span class="tick">✓</span>':''}
        <button style="margin-right:auto;width:auto" onclick="logout()">خروج</button>
      </div>
      <input id="tweetText" placeholder="چه خبر؟">
      <input type="file" id="tweetImg">
      <button onclick="sendTweet()">ارسال</button>
    </div>`

    if(me.official){
      html+=`
      <div class="box admin">
        <h4>پنل رسمی</h4>
        <div class="status">
          فقط تیک دار ها: <b>${settings.only_verified}</b><br>
          فقط رسمی: <b>${settings.only_official}</b><br>
          مدیا بسته: <b>${settings.no_media}</b>
        </div>
        <button onclick="toggle('only_verified')">فقط تیک دار ها</button>
        <button onclick="toggle('only_official')">فقط رسمی</button>
        <button onclick="toggle('no_media')">بستن مدیا</button>
        <hr>`
      for(let k in users){
        if(!users[k].official){
          html+=`
          <div>
            ${users[k].name}
            <button onclick="verify('${k}')">${users[k].verified?'برداشتن تیک':'دادن تیک'}</button>
          </div>`
        }
      }
      html+=`</div>`
    }

    html+=`<div class="box">`
    tweets.slice().reverse().forEach((t)=>{
      let canDelete = (t.username === current) || users[current].official
      html+=`
      <div>
        <div class="row">
          <img class="profile" src="${t.pic||'https://via.placeholder.com/42'}">
          <b>${t.name}</b>
          ${t.verified?'<span class="tick">✓</span>':''}
        </div>
        <p>${t.text}</p>
        ${t.image?`<img src="${t.image}" style="width:100%;border-radius:10px">`:''}
        ${canDelete ? `<button class="deleteBtn" onclick="deleteTweet(${t.id})">حذف</button>` : ""}
        <hr>
      </div>`
    })
    html+=`</div>`
  }
  document.getElementById("app").innerHTML=html
}

/* ========= AUTH ========= */
function login(){
  let u=document.getElementById("u").value
  let p=document.getElementById("p").value
  if(users[u] && users[u].password===p){ current=u; render() }
  else alert("ورود ناموفق")
}
function logout(){ current=null; render() }

/* ========= PROFILE ========= */
async function changeName(){
  let n=prompt("نام جدید"); if(!n) return
  showLoading(true)
  try{
    await supabaseClient.from("users").update({name:n}).eq("username",current)
    await loadAll()
  }finally{ showLoading(false) }
}
async function changePic(){
  let inp=document.createElement("input"); inp.type="file"
  inp.onchange=e=>{
    let file=e.target.files[0]
    let reader=new FileReader()
    reader.onload=async ()=>{
      showLoading(true)
      try{
        await supabaseClient.from("users").update({pic:reader.result}).eq("username",current)
        await loadAll()
      }finally{ showLoading(false) }
    }
    reader.readAsDataURL(file)
  }
  inp.click()
}

/* ========= TWEETS ========= */
function sendTweet(){
  let me=users[current]; if(!me) return
  if(settings.only_official && !me.official) return alert("فقط رسمی مجاز است")
  if(settings.only_verified && !(me.verified||me.official)) return alert("فقط تیک دار ها")

  let text=document.getElementById("tweetText").value.trim()
  if(!text) return alert("نمی توانید توییت خالی ارسال کنید!")

  let file=document.getElementById("tweetImg").files[0]
  if(settings.no_media && file && !me.official) return alert("مدیا بسته است")

  if(file){
    let reader=new FileReader()
    reader.onload=()=> addTweet(text,reader.result)
    reader.readAsDataURL(file)
  }else addTweet(text,"")
}

async function addTweet(text,img){
  showLoading(true)
  try{
    let me=users[current]
    await supabaseClient.from("tweets").insert({
      username:current,
      name:me.name,
      verified:me.verified,
      pic:me.pic,
      text:text,
      image:img
    })
    await loadAll()
  }finally{ showLoading(false) }
}

/* ========= DELETE ========= */
async function deleteTweet(id){
  if(!confirm("حذف شود؟")) return
  showLoading(true)
  try{
    await supabaseClient.from("tweets").delete().eq("id",id)
    await loadAll()
  }finally{ showLoading(false) }
}

/* ========= ADMIN ========= */
async function verify(u){
  let newVal=!users[u].verified
  showLoading(true)
  try{
    await supabaseClient.from("users").update({verified:newVal}).eq("username",u)
    await loadAll()
  }finally{ showLoading(false) }
}
async function toggle(s){
  let obj={}; obj[s]=!settings[s]
  showLoading(true)
  try{
    await supabaseClient.from("settings").update(obj).eq("id",1)
    await loadAll()
  }finally{ showLoading(false) }
}

/* ========= INIT ========= */
loadAll()
</script>
</body>
</html>
